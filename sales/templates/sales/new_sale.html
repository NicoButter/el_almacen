{% extends 'base.html' %}
{% load static %}
{% block title %}Nueva Venta{% endblock %}
{% block header %}Nueva Venta{% endblock %}
{% block content %}

<div class="container-fluid p-0">
  <div class="row g-0">
    <!-- Columna izquierda: Lista de productos escaneados -->
    <div class="col-md-6">
      <h2>Productos Agregados</h2>
      <ul id="product-list" class="list-group">
        <!-- Aquí se irán mostrando los productos agregados -->
      </ul>
    </div>

    <!-- Columna derecha: Escáner y selección de cliente -->
    <div class="col-md-6">
      <!-- Selección de cliente -->
      <div class="mb-3">
        <h4>Seleccionar Cliente</h4>
        <select id="cliente-select" class="form-select">
          <option value="">-- Seleccionar Cliente --</option>
          {% for cliente in clientes %}
          <option value="{{ cliente.id }}">{{ cliente.nombre }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Escáner QR -->
      <h2>Escáner QR</h2>
      <video id="video" width="100%" height="250" autoplay></video>
      <canvas id="canvas" style="display: none"></canvas>
      <p id="scan-status" class="text-muted">Esperando código QR...</p>
    </div>
  </div>

  <!-- Fila independiente para el total de la compra -->
  <div class="row mt-3">
    <div class="col-12 text-start">
      <h4>Total de la compra: <span id="total-compra">$0</span></h4>
    </div>
  </div>

  <!-- Botón para volver al dashboard del cajero -->
  <div class="row mt-3">
    <div class="col-12 text-end">
      <a href="{% url 'cashier_dashboard' %}" class="btn btn-primary">Volver al Dashboard</a>
    </div>
  </div>
</div>

<!-- Incluye la biblioteca jsQR -->
<script src="{% static 'js/jsQR.js' %}"></script>

<script>
  const confirmSound = new Audio("/static/sounds/confirm.wav");
  const productosEscaneados = new Map();
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const context = canvas.getContext("2d");
  const scanStatus = document.getElementById("scan-status");
  const totalCompraElement = document.getElementById("total-compra");

  let scanningEnabled = true; // Variable para controlar el escaneo

  navigator.mediaDevices.getUserMedia({ video: true }).then((stream) => {
    video.srcObject = stream;
    requestAnimationFrame(scanQRCode);
  });

  function agregarProductoALista(productId) {
    const productIdStr = String(productId);
    const productList = document.getElementById("product-list");

    if (productosEscaneados.has(productIdStr)) {
      return;
    }

    fetch(`/sales/api/productos/${productIdStr}/`)
      .then(response => {
        if (!response.ok) {
          throw new Error("Error al obtener el producto");
        }
        return response.json();
      })
      .then(producto => {
        if (!producto || !producto.nombre || !producto.precio_venta) {
          console.error("Producto no válido:", producto);
          return;
        }

        const li = document.createElement("li");
        li.className = "list-group-item";
        li.dataset.productId = productIdStr;

        const precio = parseFloat(producto.precio_venta.replace(',', '.'));
        const cantidad = 1;
        const totalInicial = precio * cantidad;

        // Determina el texto del precio según la unidad de venta
        const precioTexto = producto.se_vende_fraccionado ? "Precio x Kg" : "Precio x unidad";
        const unidadTexto = producto.se_vende_fraccionado ? "grs" : "unidades";

        let inputCantidad;
        if (producto.se_vende_fraccionado) {
          inputCantidad = `
                    <input type="number" min="10" max="5000" step="10" value="${cantidad}" 
                        onchange="actualizarCantidad('${productIdStr}', this.value, true)">
                    ${unidadTexto}
                `;
        } else {
          inputCantidad = `
                    <input type="number" min="1" value="${cantidad}" 
                        onchange="actualizarCantidad('${productIdStr}', this.value, false)">
                    unidades
                `;
        }

        li.innerHTML = `
                <div class="product-info">
                    <span class="product-name">${producto.nombre}</span>
                    <span class="product-price">${precioTexto}: $${precio.toFixed(2)}</span>
                </div>
                <div class="product-quantity">
                    ${inputCantidad}
                </div>
                <div class="product-total">
                    $<span class="costo">${totalInicial.toFixed(2)}</span>
                </div>
                <button class="btn btn-danger btn-sm eliminar" 
                        onclick="eliminarProducto('${productIdStr}', 1)">Eliminar</button>
            `;

        productList.appendChild(li);
        productosEscaneados.set(productIdStr, { elemento: li, cantidad: cantidad, precio_venta: precio, fraccionado: producto.se_vende_fraccionado, total: totalInicial });
        actualizarTotalCompra();
      })
      .catch(error => {
        console.error("Error:", error);
      });
  }

  function scanQRCode() {
    if (video.readyState === video.HAVE_ENOUGH_DATA && scanningEnabled) {
      canvas.height = video.videoHeight;
      canvas.width = video.videoWidth;
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imageData.data, canvas.width, canvas.height);

      if (code && code.data) {
        scanStatus.textContent = `Producto escaneado: ${code.data}`;
        agregarProductoALista(code.data);
        confirmSound.play();

        scanningEnabled = false;
        setTimeout(() => {
          scanningEnabled = true;
        }, 3000);
      } else {
        scanStatus.textContent = "Esperando código QR...";
      }
    }

    requestAnimationFrame(scanQRCode);
  }

  function actualizarCantidad(productIdStr, nuevaCantidad, esFraccionado) {
    const producto = productosEscaneados.get(productIdStr);
    if (!producto) return;

    const precio = producto.precio_venta;
    let costoTotal;

    if (esFraccionado) {
      const cantidadEnKilos = nuevaCantidad / 1000;
      costoTotal = precio * cantidadEnKilos;
    } else {
      costoTotal = precio * nuevaCantidad;
    }

    producto.elemento.querySelector('.costo').textContent = costoTotal.toFixed(2);
    producto.cantidad = nuevaCantidad;
    producto.total = costoTotal;
    actualizarTotalCompra();
  }

  function eliminarProducto(id, cantidad) {
    const item = productosEscaneados.get(id);
    if (item) {
      if (item.cantidad > 1) {
        item.cantidad -= cantidad;
        actualizarLista(item);
      } else {
        productosEscaneados.delete(id);
        const productList = document.getElementById("product-list");
        const items = productList.getElementsByTagName("li");
        for (let i = 0; i < items.length; i++) {
          if (items[i].dataset.productId === id) {
            productList.removeChild(items[i]);
            break;
          }
        }
      }
      actualizarTotalCompra();
    }
  }

  function actualizarTotalCompra() {
    let total = 0;
    productosEscaneados.forEach(item => {
      total += item.total;
    });
    totalCompraElement.textContent = `Total de la compra: $${total.toFixed(2)}`;
  }

  function realizarVenta() {
    const clienteId = document.getElementById("cliente-select").value;
    const productos = Array.from(productosEscaneados.values()).map(item => ({
        id: item.id,
        cantidad: item.cantidad,
        total: item.total
    }));

    if (!clienteId) {
        alert("Seleccione un cliente para continuar.");
        return;
    }

    fetch('/sales/api/realizar_venta/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ cliente: clienteId, productos })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert("Venta realizada exitosamente");
        } else {
            alert("Error al realizar la venta");
        }
    })
    .catch(error => console.error("Error en la venta:", error));
}
</script>

{% endblock %}
