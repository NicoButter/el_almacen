{% extends 'base.html' %}
{% load static %}
{% block title %}Nueva Venta{% endblock %}
{% block header %}Nueva Venta{% endblock %}
{% block content %}

<div class="container-fluid p-0">
  <form method="post" id="sale-form">
    {% csrf_token %}
    <div class="row g-0">
      <!-- Columna izquierda: Lista de productos escaneados -->
      <div class="col-md-6">
        <h2>Productos Agregados</h2>
        <ul id="product-list" class="list-group">
          <!-- Lista de productos agregados al carrito -->
          {% for item in scanned_items %}
            <li class="list-group-item">{{ item.name }} - {{ item.quantity }} x {{ item.price }} = {{ item.subtotal }}</li>
          {% endfor %}
        </ul>
      </div>

      <!-- Columna derecha: Escáner QR y selección de cliente -->
      <div class="col-md-6">
        <!-- Escáner QR -->
        <h2>Escáner QR</h2>
        <video id="video" width="100%" height="250" autoplay></video>
        <canvas id="canvas" style="display: none"></canvas>
        <p id="scan-status" class="text-muted">Esperando código QR...</p>

        <!-- Entrada manual del código QR como respaldo -->
        <label for="qr_code_value">Escanea un Producto:</label>
        <input type="text" name="qr_code_value" id="qr_code_value" placeholder="Código QR" class="form-control mb-2">
        <button type="submit" name="add_product" class="btn btn-secondary">Añadir Producto</button>

        <!-- Selección de cliente -->
        <div class="mb-3">
          <h4>Seleccionar Cliente</h4>
          <select id="cliente-select" name="cliente_id" class="form-select">
            <option value="">-- Seleccionar Cliente --</option>
            {% for cliente in clientes %}
              <option value="{{ cliente.id }}">{{ cliente.nombre }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
    </div>

    <!-- Total de la compra -->
    <div class="row mt-3">
      <div class="col-12 text-start">
        <h4>Total de la compra: <span id="total-compra">$0</span></h4>
      </div>
    </div>

    <!-- Botón para cerrar la venta -->
    <div class="row mt-3">
      <div class="col-12 text-end">
        <button type="submit" name="close_sale" class="btn btn-success">Cerrar Venta</button>
      </div>
    </div>
  </form>

  <div class="mb-3">
    <h4>¿Venta Fiada?</h4>
    <select id="venta-fiada" name="venta_fiada" class="form-select">
      <option value="no">No</option>
      <option value="si">Sí</option>
    </select>
  </div>

  <!-- Botón para volver al dashboard del cajero -->
  <div class="row mt-3">
    <div class="col-12 text-end">
      <a href="{% url 'cashier_dashboard' %}" class="btn btn-primary">Volver al Dashboard</a>
    </div>
  </div>
</div>


<!-- Incluye la biblioteca jsQR -->
<script src="{% static 'js/jsQR.js' %}"></script>

<script>
  const confirmSound = new Audio("/static/sounds/confirm.wav");
  const productosEscaneados = new Map();
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const context = canvas.getContext("2d");
  const scanStatus = document.getElementById("scan-status");
  const totalCompraElement = document.getElementById("total-compra");

  let scanningEnabled = true; // Variable para controlar el escaneo

  navigator.mediaDevices.getUserMedia({ video: true })
  .then((stream) => {
    video.srcObject = stream;
    requestAnimationFrame(scanQRCode);
  })
  .catch((err) => {
    console.error('Error al acceder a la cámara:', err);
    scanStatus.textContent = "No se puede acceder a la cámara";
  });

  function agregarProductoALista(productId) {
    const productIdStr = String(productId);
    const productList = document.getElementById("product-list");

    if (productosEscaneados.has(productIdStr)) {
      return;
    }

    fetch(`/sales/api/productos/${productIdStr}/`)
      .then(response => {
        if (!response.ok) {
          throw new Error("Error al obtener el producto");
        }
        return response.json();
      })
      .then(producto => {
        if (!producto || !producto.nombre || !producto.precio_venta) {
          console.error("Producto no válido:", producto);
          return;
        }

        const li = document.createElement("li");
        li.className = "list-group-item";
        li.dataset.productId = productIdStr;

        const precio = parseFloat(producto.precio_venta.replace(',', '.'));
        const cantidad = 1;
        let totalInicial = precio * cantidad;

        // Si el producto se vende fraccionado, calculamos en base a la cantidad en gramos
        if (producto.se_vende_fraccionado) {
          totalInicial = precio * (cantidad / 1000); // Convertimos gramos a kilogramos
        } else {
          totalInicial = precio * cantidad;
        }

        // Determina el texto del precio según la unidad de venta
        const precioTexto = producto.se_vende_fraccionado ? "Precio x Kg" : "Precio x unidad";
        const unidadTexto = producto.se_vende_fraccionado ? "grs" : "unidades";

        let inputCantidad;
        if (producto.se_vende_fraccionado) {
          inputCantidad = `
                    <input type="number" min="10" max="5000" step="10" value="${cantidad}" 
                        onchange="actualizarCantidad('${productIdStr}', this.value, true)">
                    ${unidadTexto}
                `;
        } else {
          inputCantidad = `
                    <input type="number" min="1" value="${cantidad}" 
                        onchange="actualizarCantidad('${productIdStr}', this.value, false)">
                    unidades
                `;
        }

        li.innerHTML = `
                <div class="product-info">
                    <span class="product-name">${producto.nombre}</span>
                    <span class="product-price">${precioTexto}: $${precio.toFixed(2)}</span>
                </div>
                <div class="product-quantity">
                    ${inputCantidad}
                </div>
                <div class="product-total">
                    $<span class="costo">${totalInicial.toFixed(2)}</span>
                </div>
                  <i class="fas fa-trash-alt eliminar" 
                   onclick="eliminarProducto('${productIdStr}', 1)" style="cursor: pointer; color: red; font-size: 20px;">
                  </i>
            `;

        productList.appendChild(li);
        productosEscaneados.set(productIdStr, { elemento: li, cantidad: cantidad, precio_venta: precio, fraccionado: producto.se_vende_fraccionado, total: totalInicial });
        actualizarTotalCompra();
      })
      .catch(error => {
        console.error("Error:", error);
      });
  }

  function scanQRCode() {
    if (video.readyState === video.HAVE_ENOUGH_DATA && scanningEnabled) {
      canvas.height = video.videoHeight;
      canvas.width = video.videoWidth;
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imageData.data, canvas.width, canvas.height);

      if (code && code.data) {
        scanStatus.textContent = `Producto escaneado: ${code.data}`;
        agregarProductoALista(code.data);
        confirmSound.play();

        scanningEnabled = false;
        setTimeout(() => {
          scanningEnabled = true;
        }, 3000);
      } else {
        scanStatus.textContent = "Esperando código QR...";
      }
    }

    requestAnimationFrame(scanQRCode);
  }

  function actualizarCantidad(productIdStr, nuevaCantidad, esFraccionado) {
    const producto = productosEscaneados.get(productIdStr);
    if (!producto) return;

    const precio = producto.precio_venta;
    let costoTotal;

    if (esFraccionado) {
      const cantidadEnKilos = nuevaCantidad / 1000;
      costoTotal = precio * cantidadEnKilos;
    } else {
      costoTotal = precio * nuevaCantidad;
    }

    producto.elemento.querySelector('.costo').textContent = costoTotal.toFixed(2);
    producto.cantidad = nuevaCantidad;
    producto.total = costoTotal;
    actualizarTotalCompra();
  }

  function eliminarProducto(id, cantidad) {
    const item = productosEscaneados.get(id);
    if (item) {
      if (item.cantidad > 1) {
        item.cantidad -= cantidad;
        actualizarLista(item);
      } else {
        productosEscaneados.delete(id);
        const productList = document.getElementById("product-list");
        const items = productList.getElementsByTagName("li");
        for (let i = 0; i < items.length; i++) {
          if (items[i].dataset.productId === id) {
            productList.removeChild(items[i]);
            break;
          }
        }
      }
      actualizarTotalCompra();
    }
  }

  function actualizarTotalCompra() {
    let total = 0;
    productosEscaneados.forEach(producto => {
      total += producto.total;
    });
    totalCompraElement.textContent = `$${total.toFixed(2)}`;
  }

  // Evento para procesar el formulario y enviar la venta
  document.getElementById("sale-form").addEventListener("submit", (e) => {
    e.preventDefault();

    const clienteId = document.getElementById("cliente-select").value;
    if (!clienteId) {
      alert("Debes seleccionar un cliente para continuar.");
      return;
    }

    const productosData = Array.from(productosEscaneados.values()).map(producto => ({
      id: parseInt(producto.elemento.dataset.productId),
      cantidad: producto.cantidad,
      total: producto.total,
      precio_unitario: producto.precio_venta 
    }));
    
    // Calcular el total de la compra sumando los totales de los productos
    const totalCompra = productosData.reduce((total, producto) => total + producto.total, 0);
    const ventaFiada = document.getElementById("venta-fiada").value || ''; 

    const data = {
      cliente_id: parseInt(clienteId),
      productos: productosData,
      total: parseFloat(totalCompra) || 0,
      venta_fiada: ventaFiada
    };

    console.log("Objeto JSON que se enviará al backend:", data);

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch("/sales/api/realizar-venta/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrfToken
      },
      body: JSON.stringify(data)
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert("Venta registrada con éxito");
          window.location.href = `/sales/tickets/${data.ticket_id}/`;
        } else {
          alert("Error al registrar la venta");
        }
      })
      .catch(error => {
        console.error("Error:", error);
        alert("Hubo un problema al procesar la venta.");
      });
  });

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

</script>

{% endblock %}
