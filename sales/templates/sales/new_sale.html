{% extends 'base.html' %}

{% load static %}

{% block extra_styles %}
  <link href="{% static 'sales/css/new_sale_styles.css' %}" rel="stylesheet"/>
{% endblock %}

{% block title %}Terminal de Venta{% endblock %}

{% block header_title %}
    Terminal de venta
{% endblock %}

{% block content %}

<div class="container">
  <form method="post" id="sale-form">
    {% csrf_token %}
    <div class="row">
      <!-- Columna izquierda: Lista de productos escaneados -->
      <div class="section">
        <h2>Productos Agregados</h2>
        <ul id="product-list" class="list-group">
          <!-- Lista de productos agregados al carrito -->
          {% for item in scanned_items %}
            <li class="list-group-item">
              <!-- Contenedor de la fila -->
              <div class="product-info">
                <span class="product-name">{{ item.name }}</span>
                <div class="product-price">Precio: ${{ item.price }} / {{ item.unit }}</div>
              </div>
              <div class="product-quantity">
                <input type="number" min="1" value="{{ item.quantity }}" class="quantity-input">
              </div>
              <div class="product-total">
                <span class="product-subtotal">${{ item.subtotal }}</span>
              </div>
              <div class="product-remove">
                <button class="delete-button" data-item-id="{{ item.id }}">üóëÔ∏è</button>
              </div>
            </li>
          {% endfor %}
        </ul>        
      </div>

      <!-- Columna derecha: Esc√°ner QR y selecci√≥n de cliente -->
      <div class="section">
        <h2>Esc√°ner QR</h2>
<div class="camera-container">
  <video id="video-bg" class="video-animation" autoplay loop muted>
    <source src="/static/sales/video/qr_scanner.mp4" type="video/mp4">
    Tu navegador no soporta el video.
  </video>
  <video id="video" autoplay></video> <!-- Este es el video de la c√°mara -->
  <canvas id="canvas" style="display: none"></canvas>
  <div class="laser-overlay"></div> <!-- Capa con animaci√≥n de l√°ser -->
</div>
<p id="scan-status">Esperando c√≥digo QR...</p>
      
      <!-- Contenedor de la imagen del producto escaneado -->
      <div id="product-image-container" style="display: none;">
          <img id="product-image" src="" alt="Producto Escaneado">
      </div>
        



        <label for="qr_code_value">Escanea un Producto:</label>
        <input type="text" name="qr_code_value" id="qr_code_value" placeholder="C√≥digo QR" class="input-field">
        <button type="submit" name="add_product" class="button">A√±adir Producto</button>
        
        <!-- Selecci√≥n de cliente y venta fiada -->
        <div class="field-group">
          <h4>Seleccionar Cliente</h4>
          <select id="cliente-select" name="cliente_id" class="select-field">
            <option value="">-- Seleccionar Cliente --</option>
            {% for cliente in clientes %}
              <option value="{{ cliente.id }}">{{ cliente.nombre }}</option>
            {% endfor %}
          </select>
          
          <h4>¬øVenta Fiada?</h4>
          <select id="venta-fiada" name="venta_fiada" class="select-field">
            <option value="no">No</option>
            <option value="si">S√≠</option>
          </select>
        </div>
      </div>

    <div class="row">
      <div class="section flex-row">
        <h4>Total de la compra:</h4>
        <span id="total-compra">${{ total_amount }}</span> <!-- Se reemplaza con el total real -->
        <button type="submit" name="close_sale" class="button success">Cerrar Venta</button>
      </div>
    </div>
  
  <div class="row">
    <div class="section text-right">
      <a href="{% url 'cashier_dashboard' %}" class="button primary">Volver al Dashboard</a>
    </div>
  </div>
</div>





<!-- Incluye la biblioteca jsQR -->
<script src="{% static 'js/jsQR.js' %}"></script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const videoBg = document.getElementById('video-bg');
    
    // Asegurarse de que el video de fondo se reproduzca al cargar la p√°gina
    const playVideo = () => {
      videoBg.play()
        .then(() => {
          console.log('Video de fondo reproduci√©ndose al cargar la p√°gina.');
        })
        .catch((error) => {
          console.error('Error al reproducir el video de fondo:', error);
        });
    };
  
    // Intentar reproducir el video
    playVideo();
  
    // Si el video no se reproduce al cargar la p√°gina, intentar nuevamente con un retraso
    setTimeout(playVideo, 1000);
  });

  const confirmSound = new Audio("/static/sounds/confirm.wav");
  const productosEscaneados = new Map();
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const context = canvas.getContext("2d");
  const scanStatus = document.getElementById("scan-status");
  const totalCompraElement = document.getElementById("total-compra");
  
  const productImageContainer = document.getElementById("product-image-container");
  const productImage = document.getElementById("product-image");
  
  let scanningEnabled = true; // Variable para controlar el escaneo
  
  navigator.mediaDevices.getUserMedia({ video: true })
    .then((stream) => {
      video.srcObject = stream;
      requestAnimationFrame(scanQRCode); // Asegura que el escaneo comienza cuando la c√°mara est√° activa
    })
    .catch((err) => {
      console.error('Error al acceder a la c√°mara:', err);
      scanStatus.textContent = "No se puede acceder a la c√°mara";
    });
  
  function scanQRCode() {
    if (!scanningEnabled) return; // Si el escaneo est√° deshabilitado, no hacemos nada
  
    // Configuraci√≥n del canvas para capturar la imagen del video
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    context.drawImage(video, 0, 0, canvas.width, canvas.height);
  
    // Aqu√≠ se debe integrar tu l√≥gica para escanear el QR, esto depende de la librer√≠a que est√©s usando
    // Por ejemplo, con `jsQR` (si la est√°s usando) ser√≠a algo as√≠:
    // const qrCode = jsQR(context.getImageData(0, 0, canvas.width, canvas.height).data, canvas.width, canvas.height);
    
    // Si encuentras un c√≥digo QR
    if (qrCode) {
      const productId = qrCode.data; // Asumiendo que el c√≥digo QR contiene el ID del producto
      agregarProductoALista(productId);
      confirmSound.play();
    } else {
      scanStatus.textContent = "Esperando c√≥digo QR...";
    }
  
    // Continuamos escaneando
    requestAnimationFrame(scanQRCode);
  }
  
  function agregarProductoALista(productId) {
    const productIdStr = String(productId);
    const productList = document.getElementById("product-list");
  
    if (productosEscaneados.has(productIdStr)) {
      return;
    }

    // Mostrar la animaci√≥n de fondo al iniciar el escaneo
    showBackgroundVideo();

    fetch(`/sales/api/productos/${productIdStr}/`)
      .then(response => {
        if (!response.ok) {
          throw new Error("Error al obtener el producto");
        }
        return response.json();
      })
      .then(producto => {
        if (!producto || !producto.nombre || !producto.precio_venta) {
          console.error("Producto no v√°lido:", producto);
          return;
        }

        // Actualizar el fondo de la c√°mara con la imagen del producto
        if (producto.imagen) {
          const cameraContainer = document.querySelector('.camera-container');
          cameraContainer.style.backgroundImage = `url(${producto.imagen})`;
          cameraContainer.style.backgroundColor = "transparent";

          // Vuelve a mostrar la animaci√≥n despu√©s de 2 segundos
          setTimeout(() => {
            cameraContainer.style.backgroundImage = '';
            showBackgroundVideo();
          }, 2000);
        }

        const li = document.createElement("li");
        li.className = "list-group-item";
        li.dataset.productId = productIdStr;

        const precio = parseFloat(producto.precio_venta.replace(',', '.'));
        const cantidad = 1;
        let totalInicial = precio * cantidad;

        if (producto.se_vende_fraccionado) {
          totalInicial = precio * (cantidad / 1000);
        } else {
          totalInicial = precio * cantidad;
        }

        const precioTexto = producto.se_vende_fraccionado ? "Precio x Kg" : "Precio x unidad";
        const unidadTexto = producto.se_vende_fraccionado ? "grs" : "unidades";

        let inputCantidad;
        if (producto.se_vende_fraccionado) {
          inputCantidad = `
            <input type="number" min="10" max="5000" step="10" value="${cantidad}" 
              onchange="actualizarCantidad('${productIdStr}', this.value, true)">
            ${unidadTexto}
          `;
        } else {
          inputCantidad = `
            <input type="number" min="1" value="${cantidad}" 
              onchange="actualizarCantidad('${productIdStr}', this.value, false)">
            unidades
          `;
        }

        li.innerHTML = `
          <div class="product-info">
            <span class="product-name">${producto.nombre}</span>
            <span class="product-price">${precioTexto}: $${precio.toFixed(2)}</span>
          </div>
          <div class="product-quantity">
            ${inputCantidad}
          </div>
          <div class="product-total">
            $<span class="costo">${totalInicial.toFixed(2)}</span>
          </div>
          <i class="fas fa-trash-alt eliminar" 
            onclick="eliminarProducto('${productIdStr}', 1)" 
            style="cursor: pointer; color: red; font-size: 20px;">
          </i>
        `;

        productList.appendChild(li);
        productosEscaneados.set(productIdStr, { 
          elemento: li, 
          cantidad: cantidad, 
          precio_venta: precio, 
          fraccionado: producto.se_vende_fraccionado, 
          total: totalInicial 
        });
        actualizarTotalCompra();

        // Ocultar la animaci√≥n despu√©s de agregar el producto
        hideBackgroundVideo();
      })
      .catch(error => {
        console.error("Error:", error);
        hideBackgroundVideo(); // Ocultar la animaci√≥n en caso de error
      });
}

// Mostrar la animaci√≥n
function showBackgroundVideo() {
  const videoBg = document.getElementById('video-bg');
  videoBg.currentTime = 0; // Reinicia el video
  videoBg.style.display = 'block'; // Aseg√∫rate de mostrarlo
  videoBg.play().catch((error) => console.error('Error al reproducir el video:', error));
}

// Ocultar la animaci√≥n
function hideBackgroundVideo() {
  const videoBg = document.getElementById('video-bg');
  videoBg.style.display = 'none';
  videoBg.pause(); // Pausa para evitar usar recursos innecesarios
}

  function scanQRCode() {
    if (video.readyState === video.HAVE_ENOUGH_DATA && scanningEnabled) {
      canvas.height = video.videoHeight;
      canvas.width = video.videoWidth;
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imageData.data, canvas.width, canvas.height);

      if (code && code.data) {
        scanStatus.textContent = `Producto escaneado: ${code.data}`;
        agregarProductoALista(code.data);
        confirmSound.play();

        scanningEnabled = false;
        setTimeout(() => {
          scanningEnabled = true;
        }, 3000);
      } else {
        scanStatus.textContent = "Esperando c√≥digo QR...";
      }
    }

    requestAnimationFrame(scanQRCode);
  }

  function actualizarCantidad(productIdStr, nuevaCantidad, esFraccionado) {
    const producto = productosEscaneados.get(productIdStr);
    if (!producto) return;

    const precio = producto.precio_venta;
    let costoTotal;

    if (esFraccionado) {
      const cantidadEnKilos = nuevaCantidad / 1000;
      costoTotal = precio * cantidadEnKilos;
    } else {
      costoTotal = precio * nuevaCantidad;
    }

    producto.elemento.querySelector('.costo').textContent = costoTotal.toFixed(2);
    producto.cantidad = nuevaCantidad;
    producto.total = costoTotal;
    actualizarTotalCompra();
  }

  function eliminarProducto(id, cantidad) {
    const item = productosEscaneados.get(id);
    if (item) {
      if (item.cantidad > 1) {
        item.cantidad -= cantidad;
        actualizarLista(item);
      } else {
        productosEscaneados.delete(id);
        const productList = document.getElementById("product-list");
        const items = productList.getElementsByTagName("li");
        for (let i = 0; i < items.length; i++) {
          if (items[i].dataset.productId === id) {
            productList.removeChild(items[i]);
            break;
          }
        }
      }
      actualizarTotalCompra();
    }
  }

  function actualizarTotalCompra() {
    let total = 0;
    productosEscaneados.forEach(producto => {
      total += producto.total;
    });
    totalCompraElement.textContent = `$${total.toFixed(2)}`;
  }

  // Evento para procesar el formulario y enviar la venta
  document.getElementById("sale-form").addEventListener("submit", (e) => {
    e.preventDefault();

    const clienteId = document.getElementById("cliente-select").value;
    if (!clienteId) {
      alert("Debes seleccionar un cliente para continuar.");
      return;
    }

    const productosData = Array.from(productosEscaneados.values()).map(producto => ({
      id: parseInt(producto.elemento.dataset.productId),
      cantidad: producto.cantidad,
      total: producto.total,
      precio_unitario: producto.precio_venta 
    }));
    
    // Calcular el total de la compra sumando los totales de los productos
    const totalCompra = productosData.reduce((total, producto) => total + producto.total, 0);
    const ventaFiada = document.getElementById("venta-fiada").value || ''; 

    const data = {
      cliente_id: parseInt(clienteId),
      productos: productosData,
      total: parseFloat(totalCompra) || 0,
      venta_fiada: ventaFiada
    };

    console.log("Objeto JSON que se enviar√° al backend:", data);

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch("/sales/api/realizar-venta/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrfToken
      },
      body: JSON.stringify(data)
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert("Venta registrada con √©xito");
          window.location.href = `/sales/tickets/${data.ticket_id}/`;
        } else {
          alert("Error al registrar la venta");
        }
      })
      .catch(error => {
        console.error("Error:", error);
        alert("Hubo un problema al procesar la venta.");
      });
  });

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

</script>

{% endblock %}