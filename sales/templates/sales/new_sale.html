{% extends 'base.html' %} 
{% load static %} 
{% block title %}Nueva Venta{% endblock %} 
{% block header %}Nueva Venta{% endblock %} 
{% block content %}

<link rel="stylesheet" href="{% static 'sales/css/new_sale_styles.css' %}" />

<div class="row">
  <!-- Lista de productos escaneados -->
  <div class="col-md-6">
    <h2>Productos Agregados</h2>
    <ul id="product-list" class="list-group">
      <!-- Aquí se irán mostrando los productos agregados -->
    </ul>
  </div>

  <!-- Escáner QR a la derecha -->
  <div class="col-md-6">
    <h2>Escáner QR</h2>
    <video id="video" width="250" height="250" autoplay></video>
    <canvas id="canvas" style="display: none"></canvas>
    <p id="scan-status" class="text-muted">Esperando código QR...</p>
  </div>
</div>

<!-- Fila independiente para el total de la compra, fuera de la lista de productos -->
<div class="row mt-3">
  <div class="col-md-12 text-start">
    <h4>Total de la compra: <span id="total-compra">$0</span></h4>
  </div>
</div>

<!-- Botón para volver al dashboard del cajero -->
<div class="row mt-3">
  <div class="col-md-12 text-end">
    <a href="{% url 'cashier_dashboard' %}" class="btn btn-primary">Volver al Dashboard</a>
  </div>
</div>

<!-- Incluye la biblioteca jsQR -->
<script src="{% static 'js/jsQR.js' %}"></script>

<script>
  const confirmSound = new Audio("/static/sounds/confirm.wav");
  const productosEscaneados = new Map();
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const context = canvas.getContext("2d");
  const scanStatus = document.getElementById("scan-status");
  const totalCompraElement = document.getElementById("total-compra");

  let scanningEnabled = true; // Variable para controlar el escaneo

  navigator.mediaDevices.getUserMedia({ video: true }).then((stream) => {
    video.srcObject = stream;
    requestAnimationFrame(scanQRCode);
  });

  function scanQRCode() {
    if (video.readyState === video.HAVE_ENOUGH_DATA && scanningEnabled) {
      canvas.height = video.videoHeight;
      canvas.width = video.videoWidth;
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imageData.data, canvas.width, canvas.height);

      if (code && code.data) {
        console.log("Código escaneado:", code.data); // Muestra el código QR escaneado

        scanStatus.textContent = `Producto escaneado: ${code.data}`;
        agregarProductoALista(code.data);
        confirmSound.play();

        // Deshabilitar escaneo por 3 segundos
        scanningEnabled = false;
        setTimeout(() => {
          scanningEnabled = true; // Rehabilitar escaneo después de 3 segundos
        }, 3000);
      } else {
        scanStatus.textContent = "Esperando código QR...";
      }
    }

    requestAnimationFrame(scanQRCode);
  }

  function agregarProductoALista(productId) {
    const productIdStr = String(productId);
    console.log("Producto escaneado ID:", productIdStr);
  
    const productList = document.getElementById("product-list");

    // Si el producto ya fue escaneado, no hacer nada
    if (productosEscaneados.has(productIdStr)) {
      console.log("El producto ya está en la lista.");
      return; // Detener la ejecución si el producto ya existe
    }

    // Si el producto no ha sido escaneado, hacer la solicitud al API
    fetch(`http://127.0.0.1:8001/sales/api/productos/${productIdStr}/`)  
      .then(response => {
        if (!response.ok) {
          throw new Error("Error al obtener el producto");
        }
        return response.json();
      })
      .then(producto => {
        console.log("Producto encontrado:", producto);
        if (!producto || !producto.nombre || !producto.precio) {
          console.error("Producto no válido:", producto);
          return; // Detener ejecución si el producto es inválido
        }

        // Crear el elemento de lista para el producto
        const li = document.createElement("li");
        li.className = "list-group-item";
        li.dataset.productId = productIdStr;

        // Inicializar la cantidad en 1
        const cantidad = 1;
        const precio = parseFloat(producto.precio.replace(',', '.'));

        // Configurar el HTML del producto
        li.innerHTML = `
        <div>
          <span class="product-name">${producto.nombre}</span>
          <span class="product-price" style="font-size: 0.8em;">($${precio.toFixed(2)})</span>
        </div>
        <span class="cantidad">(x${cantidad})</span> -> 
        $<span class="costo">${(precio * cantidad).toFixed(2)}</span> 
        <input type="number" min="1" value="${cantidad}" onchange="actualizarCantidad('${productIdStr}', this.value)">
        <button class="btn btn-success btn-sm float-end" onclick="aumentarCantidad('${productIdStr}')">+</button>
        <button class="btn btn-danger btn-sm float-end" onclick="eliminarProducto('${productIdStr}', 1)">Eliminar</button>
      `;

        productList.appendChild(li);
        productosEscaneados.set(productIdStr, { elemento: li, cantidad: cantidad, precio: precio });
        
        actualizarTotalCompra();
  
        // Agregar el ID del producto escaneado a un campo oculto del formulario
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = 'scanned_products[]';
        hiddenInput.value = JSON.stringify([...productosEscaneados.entries()]);
        document.querySelector('form').appendChild(hiddenInput);
      })
      .catch(error => {
        console.error("Error:", error);
      });
  }

  function actualizarCantidad(productId, nuevaCantidad) {
      const item = productosEscaneados.get(productId);
      if (item) {
          item.cantidad = parseInt(nuevaCantidad);
          actualizarLista(item);
          actualizarTotalCompra();
      }
  }

  function aumentarCantidad(productId) {
    const item = productosEscaneados.get(productId);
    if (item) {
      item.cantidad += 1;
      actualizarLista(item);
      actualizarTotalCompra();
    }
  }

  function eliminarProducto(id, cantidad) {
    const item = productosEscaneados.get(id);
    if (item) {
      if (item.cantidad > 1) {
        item.cantidad -= cantidad;
        actualizarLista(item);
      } else {
        productosEscaneados.delete(id);
        const productList = document.getElementById("product-list");
        const items = productList.getElementsByTagName("li");
        for (let i = 0; i < items.length; i++) {
          if (items[i].dataset.productId === id) {
            productList.removeChild(items[i]);
            break;
          }
        }
      }
      actualizarTotalCompra();
    }
  }

  function actualizarLista(item) {
    const cantidad = item.cantidad;
    const total = cantidad * item.precio;

    // Actualiza los elementos en la lista
    const cantidadElement = item.elemento.querySelector('.cantidad');
    const costoElement = item.elemento.querySelector('.costo');

    if (cantidadElement && costoElement) {
        cantidadElement.textContent = `(x${cantidad})`;
        costoElement.textContent = total.toFixed(2);
    } else {
        console.error("Elemento de cantidad o costo no encontrado");
    }
  }

  function actualizarTotalCompra() {
    let totalCompra = 0;
    productosEscaneados.forEach(item => {
      totalCompra += item.cantidad * item.precio;
    });
    totalCompraElement.textContent = `$${totalCompra.toFixed(2)}`;
  }
</script>

{% endblock %}
